{% extends "base.html" %}

{% block title %}Créer un Projet - FlowERP{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tickets.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
    .wizard-container {
        max-width: 1200px;
        margin: 2rem auto;
    }
    
    .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3rem;
        position: relative;
    }
    
    .wizard-steps::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e2e8f0;
        z-index: 0;
    }
    
    .wizard-step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }
    
    .wizard-step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 3px solid #e2e8f0;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        transition: all 0.3s;
    }
    
    .wizard-step.active .wizard-step-circle {
        background: #667eea;
        border-color: #667eea;
        color: white;
    }
    
    .wizard-step.completed .wizard-step-circle {
        background: #10b981;
        border-color: #10b981;
        color: white;
    }
    
    .wizard-step-label {
        font-size: 0.9rem;
        color: #64748b;
    }
    
    .wizard-step.active .wizard-step-label {
        color: #667eea;
        font-weight: 600;
    }
    
    .form-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .form-section h3 {
        margin-bottom: 1.5rem;
        color: #1e293b;
        font-size: 1.25rem;
    }
    
    .wizard-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
    }
    
    .step-content {
        display: none;
    }
    
    .step-content.active {
        display: block;
    }
    
    .member-selector {
        border: 2px dashed #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        min-height: 100px;
    }
    
    .selected-member {
        display: inline-block;
        background: #f1f5f9;
        padding: 8px 12px;
        border-radius: 6px;
        margin: 4px;
    }
    
    .tag-input-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        min-height: 45px;
    }
    
    .tag-badge {
        background: #667eea;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .tag-badge button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0;
        font-size: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- En-tête -->
    <div class="text-center mb-4">
        <h1><i class="fas fa-rocket"></i> Créer un Nouveau Projet</h1>
        <p class="text-muted">Suivez les étapes pour configurer votre projet</p>
    </div>
    
    <!-- Étapes du wizard -->
    <div class="wizard-steps">
        <div class="wizard-step active" data-step="1">
            <div class="wizard-step-circle">1</div>
            <div class="wizard-step-label">Informations</div>
        </div>
        <div class="wizard-step" data-step="2">
            <div class="wizard-step-circle">2</div>
            <div class="wizard-step-label">Planning</div>
        </div>
        <div class="wizard-step" data-step="3">
            <div class="wizard-step-circle">3</div>
            <div class="wizard-step-label">Équipe</div>
        </div>
        <div class="wizard-step" data-step="4">
            <div class="wizard-step-circle">4</div>
            <div class="wizard-step-label">Budget & Jalons</div>
        </div>
        <div class="wizard-step" data-step="5">
            <div class="wizard-step-circle">5</div>
            <div class="wizard-step-label">Confirmation</div>
        </div>
    </div>
    
    <form id="projectForm">
        <!-- ÉTAPE 1: Informations de base -->
        <div class="step-content active" data-step="1">
            <div class="form-section">
                <h3><i class="fas fa-info-circle"></i> Informations de Base</h3>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label">Nom du projet *</label>
                            <input type="text" class="form-control" name="name" required
                                   placeholder="Ex: Refonte du site web">
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Priorité *</label>
                            <select class="form-select" name="priority" required>
                                <option value="normal" selected>Normale</option>
                                <option value="high">Haute</option>
                                <option value="critical">Critique</option>
                                <option value="low">Basse</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" name="description" rows="4"
                              placeholder="Décrivez l'objectif et le contexte du projet..."></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Type de projet</label>
                            <select class="form-select" name="project_type">
                                <option value="internal" selected>Interne</option>
                                <option value="client">Client</option>
                                <option value="r_and_d">R&D</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Méthodologie</label>
                            <select class="form-select" name="methodology" id="methodologySelect">
                                <option value="agile" selected>Agile/Scrum</option>
                                <option value="waterfall">Waterfall</option>
                                <option value="kanban">Kanban</option>
                                <option value="hybrid">Hybride</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Département</label>
                            <select class="form-select" name="department_id" id="departmentSelect">
                                <option value="">Aucun</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Tags</label>
                    <div class="tag-input-wrapper" id="tagContainer">
                        <input type="text" id="tagInput" placeholder="Ajouter un tag..." 
                               style="border: none; outline: none; flex: 1; min-width: 120px;">
                    </div>
                    <small class="text-muted">Appuyez sur Entrée pour ajouter un tag</small>
                </div>
            </div>
        </div>
        
        <!-- ÉTAPE 2: Planning -->
        <div class="step-content" data-step="2">
            <div class="form-section">
                <h3><i class="fas fa-calendar-alt"></i> Planning et Dates</h3>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Date de début *</label>
                            <input type="date" class="form-control" name="start_date" required>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Date de fin estimée *</label>
                            <input type="date" class="form-control" name="end_date" required>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Heures estimées</label>
                    <input type="number" class="form-control" name="estimated_hours" 
                           placeholder="Ex: 160">
                    <small class="text-muted">Estimation totale en heures</small>
                </div>
                
                <!-- Configuration Sprints (si Agile) -->
                <div id="sprintConfig" style="display: none;">
                    <hr class="my-4">
                    <h4 class="h6 mb-3">Configuration des Sprints</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Durée d'un sprint (semaines)</label>
                                <input type="number" class="form-control" name="sprint_duration" 
                                       value="2" min="1" max="4">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombre de sprints</label>
                                <input type="number" class="form-control" name="sprint_count" 
                                       value="4" min="1" max="20">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÉTAPE 3: Équipe -->
        <div class="step-content" data-step="3">
            <div class="form-section">
                <h3><i class="fas fa-users"></i> Équipe du Projet</h3>
                
                <div class="mb-4">
                    <label class="form-label">Chef de projet *</label>
                    <select class="form-select" name="project_manager_id" id="managerSelect" required>
                        <option value="">Sélectionner...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Membres de l'équipe</label>
                    <div class="input-group mb-2">
                        <select class="form-select" id="memberSelect">
                            <option value="">Ajouter un membre...</option>
                        </select>
                        <button type="button" class="btn btn-primary" onclick="addMember()">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                    
                    <div class="member-selector" id="selectedMembers">
                        <p class="text-muted text-center my-3">Aucun membre ajouté</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÉTAPE 4: Budget et Jalons -->
        <div class="step-content" data-step="4">
            <div class="form-section">
                <h3><i class="fas fa-dollar-sign"></i> Budget</h3>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="enableBudget" checked>
                    <label class="form-check-label" for="enableBudget">
                        Activer le suivi budgétaire
                    </label>
                </div>
                
                <div id="budgetConfig">
                    <div class="mb-3">
                        <label class="form-label">Budget total</label>
                        <input type="number" class="form-control" name="total_budget" 
                               placeholder="Ex: 50000" step="0.01">
                    </div>
                </div>
            </div>
            
            <div class="form-section mt-3">
                <h3><i class="fas fa-flag-checkered"></i> Jalons (Milestones)</h3>
                
                <div id="milestonesContainer">
                    <p class="text-muted">Aucun jalon défini</p>
                </div>
                
                <button type="button" class="btn btn-outline-primary" onclick="addMilestone()">
                    <i class="fas fa-plus"></i> Ajouter un jalon
                </button>
            </div>
        </div>
        
        <!-- ÉTAPE 5: Confirmation -->
        <div class="step-content" data-step="5">
            <div class="form-section">
                <h3><i class="fas fa-check-circle"></i> Résumé du Projet</h3>
                
                <div id="projectSummary"></div>
                
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> Vous pourrez modifier ces informations ultérieurement.
                </div>
            </div>
        </div>
        
        <!-- Actions du wizard -->
        <div class="wizard-actions">
            <button type="button" class="btn btn-secondary" id="prevBtn" onclick="changeStep(-1)">
                <i class="fas fa-arrow-left"></i> Précédent
            </button>
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                Suivant <i class="fas fa-arrow-right"></i>
            </button>
            <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                <i class="fas fa-rocket"></i> Créer le Projet
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentStep = 1;
    const totalSteps = 5;
    let projectMembers = [];
    let projectTags = [];
    let projectMilestones = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
        loadDepartments();
        setupTagInput();
        setupMethodologyChange();
        updateStepButtons();
    });
    
    async function loadUsers() {
        try {
            const response = await fetch('/users/list');
            const data = await response.json();
            
            if (data.success) {
                const managerSelect = document.getElementById('managerSelect');
                const memberSelect = document.getElementById('memberSelect');
                
                data.users.forEach(user => {
                    const option = new Option(user.full_name || user.username, user.id);
                    managerSelect.add(option.cloneNode(true));
                    memberSelect.add(option.cloneNode(true));
                });
            }
        } catch (error) {
            console.error('Erreur chargement users:', error);
        }
    }
    
    async function loadDepartments() {
        try {
            const response = await fetch('/department/list');
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('departmentSelect');
                data.departments.forEach(dept => {
                    select.add(new Option(dept.name, dept.id));
                });
            }
        } catch (error) {
            console.error('Erreur chargement départements:', error);
        }
    }
    
    function setupTagInput() {
        const input = document.getElementById('tagInput');
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const tag = this.value.trim();
                if (tag && !projectTags.includes(tag)) {
                    projectTags.push(tag);
                    renderTags();
                    this.value = '';
                }
            }
        });
    }
    
    function renderTags() {
        const container = document.getElementById('tagContainer');
        const input = document.getElementById('tagInput');
        
        container.querySelectorAll('.tag-badge').forEach(el => el.remove());
        
        projectTags.forEach(tag => {
            const badge = document.createElement('div');
            badge.className = 'tag-badge';
            badge.innerHTML = `
                ${tag}
                <button type="button" onclick="removeTag('${tag}')">&times;</button>
            `;
            container.insertBefore(badge, input);
        });
    }
    
    function removeTag(tag) {
        projectTags = projectTags.filter(t => t !== tag);
        renderTags();
    }
    
    function addMember() {
        const select = document.getElementById('memberSelect');
        const userId = select.value;
        const userName = select.options[select.selectedIndex].text;
        
        if (!userId) return;
        
        if (projectMembers.some(m => m.user_id === parseInt(userId))) {
            alert('Ce membre est déjà ajouté');
            return;
        }
        
        projectMembers.push({ user_id: parseInt(userId), name: userName, role: '' });
        renderMembers();
        select.value = '';
    }
    
    function renderMembers() {
        const container = document.getElementById('selectedMembers');
        
        if (projectMembers.length === 0) {
            container.innerHTML = '<p class="text-muted text-center my-3">Aucun membre ajouté</p>';
            return;
        }
        
        container.innerHTML = projectMembers.map((member, index) => `
            <div class="selected-member">
                <i class="fas fa-user"></i> ${member.name}
                <button type="button" class="btn btn-sm" onclick="removeMember(${index})">
                    &times;
                </button>
            </div>
        `).join('');
    }
    
    function removeMember(index) {
        projectMembers.splice(index, 1);
        renderMembers();
    }
    
    function addMilestone() {
        const name = prompt('Nom du jalon:');
        if (!name) return;
        
        const date = prompt('Date cible (YYYY-MM-DD):');
        if (!date) return;
        
        projectMilestones.push({ name, target_date: date });
        renderMilestones();
    }
    
    function renderMilestones() {
        const container = document.getElementById('milestonesContainer');
        
        if (projectMilestones.length === 0) {
            container.innerHTML = '<p class="text-muted">Aucun jalon défini</p>';
            return;
        }
        
        container.innerHTML = projectMilestones.map((m, i) => `
            <div class="alert alert-secondary">
                <strong>${m.name}</strong> - ${new Date(m.target_date).toLocaleDateString('fr-FR')}
                <button type="button" class="btn-close float-end" onclick="removeMilestone(${i})"></button>
            </div>
        `).join('');
    }
    
    function removeMilestone(index) {
        projectMilestones.splice(index, 1);
        renderMilestones();
    }
    
    function setupMethodologyChange() {
        document.getElementById('methodologySelect').addEventListener('change', function() {
            document.getElementById('sprintConfig').style.display = 
                this.value === 'agile' ? 'block' : 'none';
        });
    }
    
    function changeStep(direction) {
        const newStep = currentStep + direction;
        
        if (newStep < 1 || newStep > totalSteps) return;
        
        // Validation avant passage étape suivante
        if (direction > 0 && !validateStep(currentStep)) return;
        
        // Masquer étape actuelle
        document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.remove('active');
        document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
        
        // Marquer comme complétée si on avance
        if (direction > 0) {
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('completed');
        }
        
        // Afficher nouvelle étape
        currentStep = newStep;
        document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');
        document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
        
        // Générer résumé si dernière étape
        if (currentStep === totalSteps) {
            generateSummary();
        }
        
        updateStepButtons();
    }
    
    function validateStep(step) {
        const form = document.getElementById('projectForm');
        const stepContent = document.querySelector(`.step-content[data-step="${step}"]`);
        const requiredInputs = stepContent.querySelectorAll('[required]');
        
        for (let input of requiredInputs) {
            if (!input.value) {
                input.focus();
                alert('Veuillez remplir tous les champs obligatoires');
                return false;
            }
        }
        
        return true;
    }
    
    function updateStepButtons() {
        document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'inline-block';
        document.getElementById('nextBtn').style.display = currentStep === totalSteps ? 'none' : 'inline-block';
        document.getElementById('submitBtn').style.display = currentStep === totalSteps ? 'inline-block' : 'none';
    }
    
    function generateSummary() {
        const formData = new FormData(document.getElementById('projectForm'));
        const data = Object.fromEntries(formData.entries());
        
        const summary = `
            <div class="row">
                <div class="col-md-6">
                    <h5>Informations Générales</h5>
                    <ul class="list-unstyled">
                        <li><strong>Nom:</strong> ${data.name}</li>
                        <li><strong>Priorité:</strong> ${data.priority}</li>
                        <li><strong>Type:</strong> ${data.project_type}</li>
                        <li><strong>Méthodologie:</strong> ${data.methodology}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>Planning</h5>
                    <ul class="list-unstyled">
                        <li><strong>Début:</strong> ${new Date(data.start_date).toLocaleDateString('fr-FR')}</li>
                        <li><strong>Fin:</strong> ${new Date(data.end_date).toLocaleDateString('fr-FR')}</li>
                        <li><strong>Heures estimées:</strong> ${data.estimated_hours || 'Non défini'}</li>
                    </ul>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <h5>Équipe</h5>
                    <p><strong>Membres:</strong> ${projectMembers.length} personne(s)</p>
                    <p><strong>Jalons:</strong> ${projectMilestones.length}</p>
                </div>
            </div>
        `;
        
        document.getElementById('projectSummary').innerHTML = summary;
    }
    
    document.getElementById('projectForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        // Ajouter données supplémentaires
        data.tags = projectTags;
        data.members = projectMembers;
        data.milestones = projectMilestones;
        
        // Configuration sprints si Agile
        if (data.methodology === 'agile') {
            data.sprints = {
                duration_weeks: parseInt(data.sprint_duration),
                count: parseInt(data.sprint_count)
            };
        }
        
        try {
            const response = await fetch('/projects/api/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('✅ Projet créé avec succès!');
                window.location.href = `/projects/${result.project.id}`;
            } else {
                alert('❌ Erreur: ' + result.error);
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert('❌ Erreur de connexion au serveur');
        }
    });
</script>
{% endblock %}
