{% extends "base.html" %}

{% block title %}Dashboard - FlowERP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@7.3.0/dist/gridstack.min.css">
<style>
:root {
    --primary: #3b82f6;
    --primary-dark: #2563eb;
    --primary-light: #dbeafe;
    --secondary: #8b5cf6;
    --accent: #06b6d4;
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
    --dark: #1f2937;
    --darker: #111827;
    --light: #f8fafc;
    --lighter: #f1f5f9;
    --border: #e2e8f0;
    --border-light: #f1f5f9;
    --text: #374151;
    --text-light: #6b7280;
    --text-lighter: #9ca3af;
    
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    
    --radius: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html, body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    color: var(--text);
    line-height: 1.6;
}

.dashboard-wrapper {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* ==================== HEADER ==================== */
.dashboard-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 2rem 0;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
}

.dashboard-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.05)"><polygon points="0,0 1000,50 1000,100 0,100"/></svg>') no-repeat;
    background-size: cover;
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
    position: relative;
    z-index: 2;
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1.5rem;
}

.header-title {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.header-title-content h1 {
    font-size: 2.25rem;
    font-weight: 800;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    background: linear-gradient(135deg, #fff 0%, #e0f2fe 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header-title-content .welcome-text {
    display: block;
    font-size: 1rem;
    opacity: 0.9;
    margin-top: 0.5rem;
    font-weight: 500;
}

.header-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

/* Modern Button Styles */
.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn-primary {
    background: white;
    color: var(--primary);
    box-shadow: var(--shadow-md);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-secondary {
    background: rgba(255,255,255,0.15);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    backdrop-filter: blur(10px);
}

.btn-secondary:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

/* Header Stats Grid */
.header-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1.25rem;
}

.stat-card {
    background: rgba(255,255,255,0.15);
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.2);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--secondary));
}

.stat-card:hover {
    background: rgba(255,255,255,0.2);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.stat-value {
    font-size: 2.25rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-label {
    font-size: 0.875rem;
    opacity: 0.9;
    font-weight: 500;
}

/* ==================== MAIN CONTENT ==================== */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
    padding: 2rem;
    flex: 1;
}

/* Modern Toolbar */
.toolbar {
    background: white;
    padding: 1.5rem;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    margin-bottom: 2rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    align-items: center;
    border: 1px solid var(--border-light);
}

.toolbar-group {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.toolbar-label {
    font-weight: 600;
    color: var(--dark);
    font-size: 0.875rem;
    min-width: 100px;
}

.toolbar-control {
    padding: 0.75rem 1rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.875rem;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 150px;
    font-weight: 500;
}

.toolbar-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.date-range {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.date-range input {
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.875rem;
    transition: all 0.2s;
}

.date-range input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.toolbar-spacer {
    flex: 1;
}

/* ==================== WIDGETS GRID ==================== */
.widgets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.widget-card {
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    min-height: 320px;
    border: 1px solid var(--border-light);
}

.widget-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.widget-card:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-6px);
    border-color: var(--primary-light);
}

.widget-card:hover::before {
    opacity: 1;
}

.widget-card.fullwidth {
    grid-column: 1 / -1;
}

/* Widget Header */
.widget-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-light);
    background: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
    transition: background-color 0.2s ease;
}

.widget-header:hover {
    background: var(--lighter);
}

.widget-title-section {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
}

.widget-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--primary-light), #e0f2fe);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    font-size: 1.25rem;
    flex-shrink: 0;
}

.widget-title-content {
    min-width: 0;
}

.widget-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--dark);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.widget-meta {
    font-size: 0.75rem;
    color: var(--text-lighter);
    margin-top: 0.125rem;
    font-weight: 500;
}

.widget-controls {
    display: flex;
    gap: 0.375rem;
}

.widget-btn {
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    border-radius: 8px;
    color: var(--text-light);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.widget-btn:hover {
    background: var(--lighter);
    color: var(--primary);
    transform: scale(1.1);
}

.widget-btn.delete:hover {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
}

/* Widget Body */
.widget-body {
    flex: 1;
    padding: 1.5rem;
    overflow: auto;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #fafbfc 0%, #ffffff 100%);
}

/* KPI Widget Styling */
.kpi-content {
    text-align: center;
    width: 100%;
    padding: 1rem;
}

.kpi-value {
    font-size: 3.5rem;
    font-weight: 800;
    color: var(--primary);
    line-height: 1;
    margin-bottom: 0.75rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.kpi-label {
    font-size: 1rem;
    color: var(--text);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.kpi-sublabel {
    font-size: 0.875rem;
    color: var(--text-light);
    margin-bottom: 1.25rem;
}

.kpi-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.875rem;
    backdrop-filter: blur(10px);
}

.kpi-badge.positive {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.kpi-badge.negative {
    background: rgba(239, 68, 68, 0.15);
    color: var(--error);
    border: 1px solid rgba(239, 68, 68, 0.2);
}

/* Chart Container */
.chart-wrapper {
    width: 100%;
    height: 100%;
    position: relative;
}

.chart-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-lighter);
    flex-direction: column;
    gap: 1rem;
}

.chart-placeholder i {
    font-size: 3rem;
    opacity: 0.5;
}

/* ==================== MODAL ==================== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
    animation: fadeIn 0.3s ease;
    padding: 1rem;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-2xl);
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--border-light);
}

.modal-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    position: sticky;
    top: 0;
    z-index: 10;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.modal-close {
    background: var(--lighter);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    cursor: pointer;
    color: var(--text-light);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 1.25rem;
}

.modal-close:hover {
    background: var(--error);
    color: white;
    transform: rotate(90deg);
}

.modal-body {
    padding: 2rem;
}

.modal-footer {
    padding: 1.5rem 2rem;
    border-top: 1px solid var(--border-light);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    background: var(--lighter);
    position: sticky;
    bottom: 0;
}

/* ==================== FORM STYLES ==================== */
.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.875rem;
    font-family: inherit;
    transition: all 0.2s ease;
    background: white;
    color: var(--text);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    transform: translateY(-1px);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.form-hint {
    font-size: 0.75rem;
    color: var(--text-light);
    margin-top: 0.5rem;
}

/* ==================== TEMPLATES GRID ==================== */
.templates-section {
    margin-bottom: 2rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 1rem;
}

.template-card {
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1.5rem 1rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: center;
    background: white;
    position: relative;
    overflow: hidden;
}

.template-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.template-card:hover {
    border-color: var(--primary);
    background: var(--primary-light);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.template-card:hover::before {
    transform: scaleX(1);
}

.template-card.selected {
    border-color: var(--success);
    background: #ecfdf5;
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
}

.template-card.selected::before {
    transform: scaleX(1);
    background: var(--success);
}

.template-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 0.75rem;
    background: linear-gradient(135deg, var(--primary-light), #e0f2fe);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    font-size: 1.5rem;
}

.template-name {
    font-weight: 600;
    color: var(--dark);
    font-size: 0.875rem;
}

/* ==================== EMPTY STATE ==================== */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-light);
}

.empty-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, var(--lighter), var(--border-light));
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-lighter);
    font-size: 2.5rem;
}

.empty-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 0.5rem;
}

.empty-text {
    color: var(--text-light);
    margin-bottom: 2rem;
    font-size: 1rem;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

/* ==================== LOADING ==================== */
.loading-spinner {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.8);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 1.5rem;
    backdrop-filter: blur(8px);
}

.loading-spinner.active {
    display: flex;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loading-text {
    color: white;
    font-weight: 600;
    font-size: 1.125rem;
}

/* ==================== NOTIFICATIONS ==================== */
.notification {
    position: fixed;
    top: 2rem;
    right: 2rem;
    padding: 1rem 1.5rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    z-index: 3000;
    animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: white;
    font-weight: 600;
    max-width: 400px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
}

.notification.success {
    background: linear-gradient(135deg, var(--success), #059669);
}

.notification.error {
    background: linear-gradient(135deg, var(--error), #dc2626);
}

.notification.info {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
}

.notification.warning {
    background: linear-gradient(135deg, var(--warning), #d97706);
}

.notification-icon {
    font-size: 1.25rem;
}

/* ==================== ANIMATIONS ==================== */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        transform: translateY(30px) scale(0.95);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ==================== RESPONSIVE DESIGN ==================== */
@media (max-width: 1024px) {
    .widgets-grid {
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    }
    
    .header-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 1rem;
    }
    
    .header-content {
        padding: 0 1rem;
    }
    
    .header-top {
        flex-direction: column;
        align-items: stretch;
        gap: 1.5rem;
    }
    
    .header-title-content h1 {
        font-size: 1.75rem;
    }
    
    .header-actions {
        justify-content: stretch;
    }
    
    .btn {
        flex: 1;
        justify-content: center;
    }
    
    .toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .toolbar-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .toolbar-label {
        width: 100%;
    }
    
    .toolbar-control {
        width: 100%;
    }
    
    .widgets-grid {
        grid-template-columns: 1fr;
    }
    
    .templates-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .modal-content {
        margin: 1rem;
        max-height: calc(100vh - 2rem);
    }
    
    .modal-body {
        padding: 1.5rem;
    }
}

@media (max-width: 640px) {
    .header-stats {
        grid-template-columns: 1fr;
    }
    
    .templates-grid {
        grid-template-columns: 1fr;
    }
    
    .notification {
        top: 1rem;
        right: 1rem;
        left: 1rem;
        max-width: none;
    }
    
    .modal-header,
    .modal-footer {
        padding: 1.25rem;
    }
}

/* ==================== UTILITY CLASSES ==================== */
.text-gradient {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.glass-effect {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.hover-lift {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.hover-lift:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

/* Smooth scrolling */
html {
    scroll-behavior: smooth;
}

/* Focus styles for accessibility */
button:focus-visible,
input:focus-visible,
select:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* Selection color */
::selection {
    background: rgba(59, 130, 246, 0.2);
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-top">
                <div class="header-title">
                    <div>
                        <h2><i class="fas fa-tachometer-alt"></i>  Dashboard</h2>
                        <small>Bienvenue {{ current_user.first_name or current_user.username }}</small>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="toggleEditMode()" id="editModeBtn">
                        <i class="fas fa-edit"></i>
                        <span id="editText">Mode √âdition</span>
                    </button>
                    <button class="btn btn-secondary" onclick="saveLayout()" id="saveBtn" style="display:none;">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                    <button class="btn btn-primary" onclick="openAddWidget()">
                        <i class="fas fa-plus"></i> Ajouter Widget
                    </button>
                </div>
            </div>

            <!-- Global Stats -->
            <div class="header-stats" id="globalStats">
                <div class="stat-box">
                    <div class="stat-number" id="statDepts">0</div>
                    <div class="stat-label">D√©partements</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statEmps">0</div>
                    <div class="stat-label">Employ√©s</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statProjects">0</div>
                    <div class="stat-label">Projets Actifs</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statTickets">0</div>
                    <div class="stat-label">Tickets Ouverts</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statTables">0</div>
                    <div class="stat-label">Tables</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statEntries">0</div>
                    <div class="stat-label">Entr√©es</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <label class="toolbar-label">üìÖ P√©riode:</label>
                <select class="toolbar-control" id="timeFilter" onchange="refreshAllWidgets()">
                    <option value="today">Aujourd'hui</option>
                    <option value="week" selected>7 jours</option>
                    <option value="month">30 jours</option>
                    <option value="quarter">90 jours</option>
                    <option value="year">1 an</option>
                    <option value="custom">Personnalis√©</option>
                </select>
            </div>

            <div class="toolbar-group" id="customDateGroup" style="display:none;">
                <div class="date-range">
                    <input type="date" id="startDate" />
                    <span>√†</span>
                    <input type="date" id="endDate" />
                    <button class="btn btn-secondary" onclick="applyCustomDate()" style="white-space:nowrap;">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>

            {% if current_user.is_admin or current_user.role == 'directeur_rh' %}
            <div class="toolbar-group">
                <label class="toolbar-label">üè¢ D√©partement:</label>
                <select class="toolbar-control" id="departmentFilter" onchange="refreshAllWidgets()">
                    <option value="">Tous les d√©partements</option>
                </select>
            </div>
            {% endif %}

            <div class="toolbar-spacer"></div>

            <div class="toolbar-group">
                <button class="btn btn-secondary" onclick="refreshAllWidgets()">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
                <button class="btn btn-secondary" onclick="exportToPDF()">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Widgets Grid -->
            <div class="widgets-grid" id="widgetsGrid">
                <!-- Widgets loaded here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display:none;">
                <div class="empty-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h2 class="empty-title">Aucun Widget</h2>
                <p class="empty-text">Cr√©ez votre premier widget pour commencer l'analyse</p>
                <button class="btn btn-primary" onclick="openAddWidget()">
                    <i class="fas fa-plus"></i> Cr√©er un Widget
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== MODALS ==================== -->

<!-- Add Widget Modal -->
<div id="addWidgetModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">‚ûï Ajouter un Widget</h2>
            <button class="modal-close" onclick="closeModal('addWidgetModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div id="templatesStep">
                <h3 style="margin-bottom: 1.5rem; color: var(--dark); font-weight: 600;">Choisir un template:</h3>
                <div class="templates-grid" id="templatesGrid">
                    <!-- Templates loaded here -->
                </div>
            </div>

            <div id="configStep" style="display:none;">
                <h3 style="margin-bottom: 1.5rem; color: var(--dark); font-weight: 600;">‚öôÔ∏è Configuration:</h3>

                <div class="form-group">
                    <label class="form-label">Titre du Widget <span class="required">*</span></label>
                    <input type="text" class="form-input" id="widgetTitle" placeholder="Ex: Employ√©s par d√©partement">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Source de Donn√©es <span class="required">*</span></label>
                        <select class="form-select" id="widgetSource" onchange="updateMetrics()">
                            <option value="">S√©lectionner...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">M√©trique <span class="required">*</span></label>
                        <select class="form-select" id="widgetMetric">
                            <option value="">S√©lectionner...</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Type de Graphique <span class="required">*</span></label>
                        <select class="form-select" id="widgetChart">
                            <option value="bar">üìä Barres</option>
                            <option value="line">üìà Lignes</option>
                            <option value="pie">ü•ß Camembert</option>
                            <option value="doughnut">üç© Anneau</option>
                            <option value="radar">üéØ Radar</option>
                            <option value="polarArea">‚ùÑÔ∏è Aire Polaire</option>
                            <option value="area">üìâ Aire</option>
                            <option value="scatter">‚ö° Scatter</option>
                            <option value="bubble">üîµ Bubble</option>
                            <option value="number">üî¢ Nombre</option>
                            <option value="gauge">‚è±Ô∏è Jauge</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Taille <span class="required">*</span></label>
                        <select class="form-select" id="widgetSize">
                            <option value="1x1">Petite (1x1)</option>
                            <option value="2x1" selected>Moyenne (2x1)</option>
                            <option value="2x2">Grande (2x2)</option>
                            <option value="4x2">Extra Large (4x2)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Couleur <span class="required">*</span></label>
                        <select class="form-select" id="widgetColor">
                            <option value="blue">üîµ Bleu</option>
                            <option value="green">üü¢ Vert</option>
                            <option value="orange">üü† Orange</option>
                            <option value="purple">üü£ Violet</option>
                            <option value="red">üî¥ Rouge</option>
                            <option value="pink">ü©∑ Rose</option>
                            <option value="cyan">üíé Cyan</option>
                        </select>
                    </div>

                    {% if current_user.is_admin or current_user.role == 'directeur_rh' %}
                    <div class="form-group">
                        <label class="form-label">D√©partement (optionnel)</label>
                        <select class="form-select" id="widgetDept">
                            <option value="">Tous les d√©partements</option>
                        </select>
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label">Description (optionnel)</label>
                    <textarea class="form-textarea" id="widgetDescription" placeholder="Ajouter une description..." rows="3"></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="backBtn" onclick="backToTemplates()" style="display:none;">
                <i class="fas fa-arrow-left"></i> Retour
            </button>
            <button class="btn btn-secondary" onclick="closeModal('addWidgetModal')">Annuler</button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                Suivant <i class="fas fa-arrow-right"></i>
            </button>
            <button class="btn btn-primary" id="createBtn" onclick="createWidget()" style="display:none;">
                <i class="fas fa-check"></i> Cr√©er Widget
            </button>
        </div>
    </div>
</div>

<!-- Edit Widget Modal -->
<div id="editWidgetModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">‚úèÔ∏è Modifier le Widget</h2>
            <button class="modal-close" onclick="closeModal('editWidgetModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Titre <span class="required">*</span></label>
                <input type="text" class="form-input" id="editWidgetTitle">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Taille</label>
                    <select class="form-select" id="editWidgetSize">
                        <option value="1x1">Petite (1x1)</option>
                        <option value="2x1">Moyenne (2x1)</option>
                        <option value="2x2">Grande (2x2)</option>
                        <option value="4x2">Extra Large (4x2)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Couleur</label>
                    <select class="form-select" id="editWidgetColor">
                        <option value="blue">üîµ Bleu</option>
                        <option value="green">üü¢ Vert</option>
                        <option value="orange">üü† Orange</option>
                        <option value="purple">üü£ Violet</option>
                        <option value="red">üî¥ Rouge</option>
                        <option value="pink">ü©∑ Rose</option>
                        <option value="cyan">üíé Cyan</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="editWidgetDescription" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('editWidgetModal')">Annuler</button>
            <button class="btn btn-primary" onclick="saveWidgetChanges()">
                <i class="fas fa-save"></i> Sauvegarder
            </button>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
    <p style="color: var(--dark); font-weight: 600;">Chargement...</p>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
// ==================== VARIABLES GLOBALES ====================
let editMode = false;
let widgets = {};
let charts = {};
let selectedTemplate = null;
let editingWidgetId = null;
let currentTimeFilter = 'week';
let currentDeptFilter = '';

const METRIC_MAPS = {
    'employees': [
        { value: 'count', label: 'Nombre total' },
        { value: 'by_role', label: 'Par r√¥le' },
        { value: 'by_department', label: 'Par d√©partement' },
        { value: 'new_hires', label: 'Nouvelles embauches' }
    ],
    'projects': [
        { value: 'count', label: 'Nombre total' },
        { value: 'by_status', label: 'Par statut' },
        { value: 'completion_rate', label: 'Taux de compl√©tion' },
        { value: 'progress_trend', label: 'Tendance' }
    ],
    'tasks': [
        { value: 'count', label: 'Nombre total' },
        { value: 'by_status', label: 'Par statut' }
    ],
    'tickets': [
        { value: 'count', label: 'Nombre total' },
        { value: 'by_status', label: 'Par statut' },
        { value: 'by_priority', label: 'Par priorit√©' }
    ],
    'requests': [
        { value: 'count', label: 'Nombre total' },
        { value: 'by_type', label: 'Par type' },
        { value: 'by_status', label: 'Par statut' }
    ],
    'tables': [
        { value: 'count', label: 'Nombre de tables' },
        { value: 'entries_count', label: 'Total entr√©es' },
        { value: 'by_table', label: 'Entr√©es par table' }
    ],
    'attendance': [
        { value: 'present', label: 'Taux de pr√©sence' },
        { value: 'trend', label: 'Tendance' }
    ],
    'payroll': [
        { value: 'total_salary', label: 'Masse salariale' },
        { value: 'trend', label: 'Tendance' }
    ],
    'departments': [
        { value: 'count', label: 'Nombre total' },
        { value: 'comparison', label: 'Comparaison' }
    ]
};

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', async function() {
    await loadGlobalStats();
    await loadDepartments();
    await loadSources();
    await loadTemplates();
    await loadUserWidgets();
});

// ==================== FONCTIONS DE CHARGEMENT ====================

async function loadGlobalStats() {
    try {
        const response = await fetch('/api/dashboard/global-stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.stats;
            document.getElementById('statDepts').textContent = stats.departments;
            document.getElementById('statEmps').textContent = stats.employees;
            document.getElementById('statProjects').textContent = stats.projects;
            document.getElementById('statTickets').textContent = stats.tickets;
            document.getElementById('statTables').textContent = stats.tables;
            document.getElementById('statEntries').textContent = stats.entries.toLocaleString('fr-FR');
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadDepartments() {
    try {
        const response = await fetch('/department/list');
        const data = await response.json();
        
        if (data.success) {
            const deptFilter = document.getElementById('departmentFilter');
            const deptWidget = document.getElementById('widgetDept');
            const deptEdit = document.getElementById('editWidgetDept');
            
            data.departments.forEach(dept => {
                if (deptFilter) {
                    const opt = document.createElement('option');
                    opt.value = dept.id;
                    opt.textContent = dept.name;
                    deptFilter.appendChild(opt);
                }
                
                if (deptWidget) {
                    const opt = document.createElement('option');
                    opt.value = dept.id;
                    opt.textContent = dept.name;
                    deptWidget.appendChild(opt);
                }
                
                if (deptEdit) {
                    const opt = document.createElement('option');
                    opt.value = dept.id;
                    opt.textContent = dept.name;
                    deptEdit.appendChild(opt);
                }
            });
        }
    } catch (error) {
        console.error('Error loading departments:', error);
    }
}

async function loadSources() {
    try {
        const response = await fetch('/api/dashboard/available-sources');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('widgetSource');
            data.sources.forEach(source => {
                const opt = document.createElement('option');
                opt.value = source.id;
                opt.textContent = source.label;
                select.appendChild(opt);
            });
        }
    } catch (error) {
        console.error('Error loading sources:', error);
    }
}

async function loadTemplates() {
    try {
        const response = await fetch('/api/dashboard/templates');
        const data = await response.json();
        
        if (data.success) {
            const grid = document.getElementById('templatesGrid');
            grid.innerHTML = data.templates.map(t => `
                <div class="template-card" onclick="selectTemplate('${t.id}', ${JSON.stringify(t).replace(/"/g, '&quot;')})">
                    <div class="template-icon">${t.icon}</div>
                    <div class="template-name">${t.title}</div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading templates:', error);
    }
}

async function loadUserWidgets() {
    showLoading();
    try {
        const response = await fetch('/api/dashboard/widgets/list');
        const data = await response.json();
        
        if (data.success) {
            if (data.widgets.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('widgetsGrid').innerHTML = '';
            } else {
                document.getElementById('emptyState').style.display = 'none';
                
                data.widgets.forEach(w => {
                    addWidgetCard(w);
                    loadWidgetData(w.id);
                });
            }
        }
    } catch (error) {
        console.error('Error loading widgets:', error);
        showNotification('Erreur de chargement des widgets', 'error');
    } finally {
        hideLoading();
    }
}

// ==================== GESTION DES WIDGETS ====================

function addWidgetCard(widget) {
    const widgetHTML = `
        <div class="widget-card" data-widget-id="${widget.id}">
            <div class="widget-header">
                <div class="widget-title-section">
                    <div class="widget-icon">üìä</div>
                    <div>
                        <div class="widget-title">${widget.title}</div>
                        <div class="widget-meta">${widget.data_source} ‚Ä¢ ${widget.chart_type}</div>
                    </div>
                </div>
                <div class="widget-controls">
                    <button class="widget-btn" onclick="refreshWidget(${widget.id})" title="Actualiser">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="widget-btn" onclick="editWidgetModal(${widget.id})" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="widget-btn delete" onclick="deleteWidget(${widget.id})" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="widget-body" id="widget-${widget.id}">
                <div class="chart-placeholder">
                    <div class="spinner"></div>
                    <p>Chargement...</p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('widgetsGrid').insertAdjacentHTML('beforeend', widgetHTML);
    widgets[widget.id] = widget;
}

async function loadWidgetData(widgetId) {
    try {
        const timeFilter = document.getElementById('timeFilter').value;
        const deptFilter = document.getElementById('departmentFilter')?.value || '';
        
        let startDate = '', endDate = '';
        if (timeFilter === 'custom') {
            startDate = document.getElementById('startDate').value;
            endDate = document.getElementById('endDate').value;
        }
        
        const params = new URLSearchParams({
            time_filter: timeFilter,
            department_id: deptFilter,
            start_date: startDate,
            end_date: endDate
        });
        
        const response = await fetch(`/api/dashboard/widgets/${widgetId}/data?${params}`);
        const data = await response.json();
        
        if (data.success) {
            renderWidgetData(widgetId, data.data, widgets[widgetId]);
        }
    } catch (error) {
        console.error(`Error loading widget ${widgetId}:`, error);
        document.getElementById(`widget-${widgetId}`).innerHTML = `
            <div class="chart-placeholder">
                <i class="fas fa-exclamation-circle" style="color: var(--danger); font-size: 2rem;"></i>
                <p style="color: var(--danger);">Erreur de chargement</p>
            </div>
        `;
    }
}

function renderWidgetData(widgetId, data, widget) {
    const container = document.getElementById(`widget-${widgetId}`);
    
    if (!container) return;
    
    if (data.type === 'single') {
        // KPI
        let displayValue = data.value;
        if (data.format === 'currency') {
            displayValue = new Intl.NumberFormat('fr-TN', { style: 'currency', currency: 'TND' }).format(data.value);
        } else if (data.format === 'number') {
            displayValue = data.value.toLocaleString('fr-FR');
        }
        
        const badgeClass = (data.change || 0) >= 0 ? 'positive' : 'negative';
        const badgeIcon = (data.change || 0) >= 0 ? '‚Üë' : '‚Üì';
        
        container.innerHTML = `
            <div class="kpi-content">
                <div class="kpi-value">${displayValue}</div>
                <div class="kpi-label">${data.label}</div>
                ${data.sublabel ? `<div class="kpi-sublabel">${data.sublabel}</div>` : ''}
                ${data.change !== undefined ? `<div class="kpi-badge ${badgeClass}">${badgeIcon} ${Math.abs(data.change)}%</div>` : ''}
            </div>
        `;
    } else if (data.type === 'chart') {
        container.innerHTML = `<canvas id="chart-${widgetId}"></canvas>`;
        
        setTimeout(() => {
            const canvas = document.getElementById(`chart-${widgetId}`);
            if (canvas && canvas.getContext) {
                if (charts[widgetId]) charts[widgetId].destroy();
                
                const colors = getColorScheme(widget.color_scheme);
                
                charts[widgetId] = new Chart(canvas.getContext('2d'), {
                    type: widget.chart_type,
                    data: {
                        labels: data.labels,
                        datasets: data.datasets.map(ds => ({
                            ...ds,
                            backgroundColor: ds.backgroundColor || colors.bg,
                            borderColor: ds.borderColor || colors.border,
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', padding: 20 }
                        },
                        scales: !['pie', 'doughnut', 'radar', 'polarArea'].includes(widget.chart_type) ? {
                            y: { beginAtZero: true }
                        } : {}
                    }
                });
            }
        }, 100);
    }
}

function getColorScheme(scheme) {
    const schemes = {
        blue: { bg: '#0078d480', border: '#0078d4' },
        green: { bg: '#10b98180', border: '#10b981' },
        orange: { bg: '#f59e0b80', border: '#f59e0b' },
        purple: { bg: '#8b5cf680', border: '#8b5cf6' },
        red: { bg: '#ef444480', border: '#ef4444' },
        pink: { bg: '#ec409980', border: '#ec4099' },
        cyan: { bg: '#06b6d480', border: '#06b6d4' }
    };
    return schemes[scheme] || schemes.blue;
}

async function refreshWidget(widgetId) {
    document.getElementById(`widget-${widgetId}`).innerHTML = `
        <div class="chart-placeholder">
            <div class="spinner"></div>
        </div>
    `;
    await loadWidgetData(widgetId);
    showNotification('Widget actualis√©', 'success');
}

async function deleteWidget(widgetId) {
    if (!confirm('√ätes-vous s√ªr ?')) return;
    
    showLoading();
    try {
        const response = await fetch(`/api/dashboard/widgets/${widgetId}/delete`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            document.querySelector(`[data-widget-id="${widgetId}"]`).remove();
            delete widgets[widgetId];
            if (charts[widgetId]) charts[widgetId].destroy();
            
            if (Object.keys(widgets).length === 0) {
                document.getElementById('emptyState').style.display = 'block';
            }
            
            showNotification('Widget supprim√©', 'success');
        }
    } catch (error) {
        showNotification('Erreur de suppression', 'error');
    } finally {
        hideLoading();
    }
}

// ==================== MODAL FONCTIONS ====================

function openAddWidget() {
    document.getElementById('addWidgetModal').classList.add('active');
    document.getElementById('templatesStep').style.display = 'block';
    document.getElementById('configStep').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'inline-flex';
    document.getElementById('createBtn').style.display = 'none';
    document.getElementById('backBtn').style.display = 'none';
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function selectTemplate(id, template) {
    selectedTemplate = template;
    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
    event.target.closest('.template-card').classList.add('selected');
}

function nextStep() {
    if (!selectedTemplate) {
        showNotification('S√©lectionner un template', 'warning');
        return;
    }
    
    document.getElementById('widgetTitle').value = selectedTemplate.title;
    document.getElementById('widgetSource').value = selectedTemplate.data_source;
    document.getElementById('widgetChart').value = selectedTemplate.chart_type;
    updateMetrics();
    
    document.getElementById('templatesStep').style.display = 'none';
    document.getElementById('configStep').style.display = 'block';
    document.getElementById('nextBtn').style.display = 'none';
    document.getElementById('createBtn').style.display = 'inline-flex';
    document.getElementById('backBtn').style.display = 'inline-flex';
}

function backToTemplates() {
    document.getElementById('templatesStep').style.display = 'block';
    document.getElementById('configStep').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'inline-flex';
    document.getElementById('createBtn').style.display = 'none';
    document.getElementById('backBtn').style.display = 'none';
}

function updateMetrics() {
    const source = document.getElementById('widgetSource').value;
    const metricSelect = document.getElementById('widgetMetric');
    
    metricSelect.innerHTML = '<option value="">S√©lectionner...</option>';
    
    (METRIC_MAPS[source] || []).forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.value;
        opt.textContent = m.label;
        metricSelect.appendChild(opt);
    });
    
    if (selectedTemplate?.metric) {
        metricSelect.value = selectedTemplate.metric;
    }
}

async function createWidget() {
    const title = document.getElementById('widgetTitle').value;
    const source = document.getElementById('widgetSource').value;
    const metric = document.getElementById('widgetMetric').value;
    const chart = document.getElementById('widgetChart').value;
    const size = document.getElementById('widgetSize').value;
    const color = document.getElementById('widgetColor').value;
    const desc = document.getElementById('widgetDescription').value;
    const dept = document.getElementById('widgetDept')?.value || '';
    
    if (!title || !source || !metric || !chart) {
        showNotification('Remplir tous les champs', 'warning');
        return;
    }
    
    showLoading();
    try {
        const response = await fetch('/api/dashboard/widgets/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title, 
                widget_type: 'custom',
                data_source: source,
                chart_type: chart,
                size,
                color_scheme: color,
                description: desc,
                department_id: dept || null,
                filters: { metric }
            })
        });
        
        const data = await response.json();
        if (data.success) {
            addWidgetCard(data.widget);
            loadWidgetData(data.widget.id);
            closeModal('addWidgetModal');
            showNotification('Widget cr√©√©', 'success');
        }
    } catch (error) {
        showNotification('Erreur de cr√©ation', 'error');
    } finally {
        hideLoading();
    }
}

function editWidgetModal(widgetId) {
    const widget = widgets[widgetId];
    document.getElementById('editWidgetTitle').value = widget.title;
    document.getElementById('editWidgetSize').value = widget.size;
    document.getElementById('editWidgetColor').value = widget.color_scheme;
    document.getElementById('editWidgetDescription').value = widget.description || '';
    editingWidgetId = widgetId;
    document.getElementById('editWidgetModal').classList.add('active');
}

async function saveWidgetChanges() {
    const title = document.getElementById('editWidgetTitle').value;
    const size = document.getElementById('editWidgetSize').value;
    const color = document.getElementById('editWidgetColor').value;
    const desc = document.getElementById('editWidgetDescription').value;
    
    showLoading();
    try {
        const response = await fetch(`/api/dashboard/widgets/${editingWidgetId}/update`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title, size, color_scheme: color, description: desc
            })
        });
        
        const data = await response.json();
        if (data.success) {
            const widget = document.querySelector(`[data-widget-id="${editingWidgetId}"]`);
            widget.querySelector('.widget-title').textContent = title;
            widgets[editingWidgetId] = data.widget;
            closeModal('editWidgetModal');
            showNotification('Widget mis √† jour', 'success');
        }
    } catch (error) {
        showNotification('Erreur de mise √† jour', 'error');
    } finally {
        hideLoading();
    }
}

// ==================== FILTRES ==================== 

function handleTimeFilter() {
    const filter = document.getElementById('timeFilter').value;
    if (filter === 'custom') {
        document.getElementById('customDateGroup').style.display = 'flex';
    } else {
        document.getElementById('customDateGroup').style.display = 'none';
        refreshAllWidgets();
    }
}

function applyCustomDate() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    
    if (!start || !end) {
        showNotification('Dates requises', 'warning');
        return;
    }
    
    refreshAllWidgets();
}

function refreshAllWidgets() {
    showNotification('Actualisation...', 'info');
    Object.keys(widgets).forEach(wid => loadWidgetData(parseInt(wid)));
}

function toggleEditMode() {
    editMode = !editMode;
    document.getElementById('editModeBtn').style.display = editMode ? 'none' : 'inline-flex';
    document.getElementById('saveBtn').style.display = editMode ? 'inline-flex' : 'none';
    document.body.classList.toggle('edit-mode', editMode);
}

function saveLayout() {
    showNotification('Layout sauvegard√©', 'success');
    editMode = false;
    document.getElementById('editModeBtn').style.display = 'inline-flex';
    document.getElementById('saveBtn').style.display = 'none';
}

async function exportToPDF() {
    showNotification('Pr√©paration de l\'export...', 'info');
    const element = document.querySelector('.main-content');
    const opt = {
        margin: 10,
        filename: 'dashboard.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'landscape' }
    };
    await html2pdf().set(opt).from(element).save();
    showNotification('Export r√©ussi', 'success');
}

// ==================== UTILS ====================

function showLoading() {
    document.getElementById('loadingSpinner').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingSpinner').classList.remove('active');
}

function showNotification(msg, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${msg}`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
}
</script>
{% endblock %}