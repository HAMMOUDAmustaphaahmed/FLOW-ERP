{% extends "base.html" %}

{% block title %}{{ project.name }} - FlowERP{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tickets.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
    /* Dans votre style.css, modifier la section modals */
.modal, .modal-overlay {
    z-index: 9999 !important; /* Augmenter considérablement le z-index */
}

.modal-content, .modal-dialog {
    z-index: 10000 !important;
}
    .project-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 20px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    
    .project-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .stat-box {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }
    
    .stat-box h3 {
        font-size: 1.5rem;
        margin: 0;
    }
    
    .nav-tabs-custom {
        border-bottom: 2px solid #e2e8f0;
        margin-bottom: 20px;
    }
    
    .nav-tabs-custom .nav-link {
        border: none;
        padding: 12px 20px;
        color: #64748b;
        font-weight: 600;
        border-bottom: 3px solid transparent;
    }
    
    .nav-tabs-custom .nav-link.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: none;
    }
    
    .tab-content {
        min-height: 400px;
    }
    
    .task-item {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.2s;
    }
    
    .task-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .priority-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .priority-critical { background: #dc3545; color: white; }
    .priority-high { background: #fd7e14; color: white; }
    .priority-normal { background: #0d6efd; color: white; }
    .priority-low { background: #6c757d; color: white; }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
    }
    
    .status-todo { background: #e7f3ff; color: #0d6efd; }
    .status-in_progress { background: #fff3cd; color: #856404; }
    .status-in_review { background: #d1ecf1; color: #0c5460; }
    .status-completed { background: #d1f2eb; color: #198754; }
    
    .member-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
    
    .progress-bar-custom {
        height: 8px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.3s;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête du projet -->
    <div class="project-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1>{{ project.name }}</h1>
                <p class="mb-0">{{ project.description }}</p>
            </div>
            <div class="text-end">
                <span class="priority-badge priority-{{ project.priority }}">
                    {{ project.priority|title }}
                </span>
                <span class="status-badge status-{{ project.status }}">
                    {{ project.status|title }}
                </span>
            </div>
        </div>
        
        <div class="project-stats">
            <div class="stat-box">
                <h3 id="taskCount">0</h3>
                <p class="mb-0">Tâches</p>
            </div>
            <div class="stat-box">
                <h3>{{ project.progress_percentage }}%</h3>
                <p class="mb-0">Progression</p>
            </div>
            <div class="stat-box">
                <h3 id="memberCount">0</h3>
                <p class="mb-0">Membres</p>
            </div>
            <div class="stat-box">
                <h3>{{ project.estimated_hours or 0 }}</h3>
                <p class="mb-0">Heures estimées</p>
            </div>
        </div>
    </div>
    
    <!-- Navigation par onglets -->
    <ul class="nav nav-tabs nav-tabs-custom" id="projectTabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#overview">
                <i class="fas fa-chart-pie"></i> Vue d'ensemble
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tasks">
                <i class="fas fa-tasks"></i> Tâches
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#team">
                <i class="fas fa-users"></i> Équipe
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#milestones">
                <i class="fas fa-flag-checkered"></i> Jalons
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#settings">
                <i class="fas fa-cog"></i> Paramètres
            </a>
        </li>
    </ul>
    
    <!-- Contenu des onglets -->
    <div class="tab-content" id="projectTabsContent">
        <!-- Onglet Vue d'ensemble -->
        <div class="tab-pane fade show active" id="overview">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Progression du projet</h5>
                        </div>
                        <div class="card-body">
                            <div class="progress-bar-custom mb-3">
                                <div class="progress-fill" style="width: {{ project.progress_percentage }}%"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>{{ project.progress_percentage }}% complété</span>
                                <span id="completedTasks">0 tâches terminées</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Prochaines échéances</h5>
                        </div>
                        <div class="card-body" id="upcomingTasks">
                            <!-- Chargé dynamiquement -->
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Informations</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Chef de projet:</strong><br>
                                {{ project.project_manager.get_full_name() if project.project_manager else 'Non assigné' }}</p>
                            
                            <p><strong>Département:</strong><br>
                                {{ project.department.name if project.department else 'Aucun' }}</p>
                            
                            <p><strong>Date de début:</strong><br>
                                {{ project.start_date.strftime('%d/%m/%Y') if project.start_date else 'Non définie' }}</p>
                            
                            <p><strong>Date de fin:</strong><br>
                                {{ project.end_date.strftime('%d/%m/%Y') if project.end_date else 'Non définie' }}</p>
                            
                            <p><strong>Budget:</strong><br>
                                {{ "%.2f €"|format(project.total_budget) if project.total_budget else 'Non défini' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Onglet Tâches -->
        <div class="tab-pane fade" id="tasks">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>Gestion des tâches</h4>
                <button class="btn btn-primary" onclick="openTaskModal()">
                    <i class="fas fa-plus"></i> Nouvelle tâche
                </button>
            </div>
            
            <div id="tasksContainer">
                <!-- Chargé dynamiquement -->
            </div>
        </div>
        
        <!-- Onglet Équipe -->
        <div class="tab-pane fade" id="team">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>Membres de l'équipe</h4>
                <button class="btn btn-primary" onclick="openMemberModal()">
                    <i class="fas fa-user-plus"></i> Ajouter un membre
                </button>
            </div>
            
            <div class="row" id="teamMembers">
                <!-- Chargé dynamiquement -->
            </div>
        </div>
        
        <!-- Onglet Jalons -->
        <div class="tab-pane fade" id="milestones">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>Jalons du projet</h4>
                <button class="btn btn-primary" onclick="openMilestoneModal()">
                    <i class="fas fa-flag"></i> Nouveau jalon
                </button>
            </div>
            
            <div id="milestonesContainer">
                <!-- Chargé dynamiquement -->
            </div>
        </div>
        
        <!-- Onglet Paramètres -->
        <div class="tab-pane fade" id="settings">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Paramètres du projet</h5>
                        </div>
                        <div class="card-body">
                            <form id="projectSettingsForm">
                                <div class="mb-3">
                                    <label class="form-label">Statut</label>
                                    <select class="form-select" name="status">
                                        <option value="planned" {{ 'selected' if project.status == 'planned' }}>Planifié</option>
                                        <option value="active" {{ 'selected' if project.status == 'active' }}>Actif</option>
                                        <option value="completed" {{ 'selected' if project.status == 'completed' }}>Terminé</option>
                                        <option value="suspended" {{ 'selected' if project.status == 'suspended' }}>Suspendu</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Priorité</label>
                                    <select class="form-select" name="priority">
                                        <option value="low" {{ 'selected' if project.priority == 'low' }}>Basse</option>
                                        <option value="normal" {{ 'selected' if project.priority == 'normal' }}>Normale</option>
                                        <option value="high" {{ 'selected' if project.priority == 'high' }}>Haute</option>
                                        <option value="critical" {{ 'selected' if project.priority == 'critical' }}>Critique</option>
                                    </select>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-success" onclick="markProjectComplete()">
                                        <i class="fas fa-check-circle"></i> Marquer comme terminé
                                    </button>
                                </div>
                                <script>
                                    async function markProjectComplete() {
                                        if (!confirm('Êtes-vous sûr de vouloir marquer ce projet comme terminé ?')) {
                                            return;
                                        }
                                        
                                        try {
                                            const response = await fetch(`/projects/api/${projectId}/mark-complete`, {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' }
                                            });
                                            
                                            const result = await response.json();
                                            
                                            if (result.success) {
                                                showAlert('success', 'Projet marqué comme terminé');
                                                location.reload();
                                            } else {
                                                showAlert('error', result.error);
                                            }
                                        } catch (error) {
                                            console.error('Erreur:', error);
                                            showAlert('error', 'Erreur de connexion');
                                        }
                                    }
                                    </script>
                                
                                <button type="submit" class="btn btn-primary">Enregistrer</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour créer/modifier une tâche -->
<div class="modal fade" id="taskModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nouvelle Tâche</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="mb-3">
                        <label class="form-label">Titre *</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Assigner à</label>
                                <select class="form-select" name="assigned_to_id">
                                    <option value="">Non assigné</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Priorité</label>
                                <select class="form-select" name="priority">
                                    <option value="P3">Normale</option>
                                    <option value="P1">Critique</option>
                                    <option value="P2">Haute</option>
                                    <option value="P4">Basse</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Date d'échéance</label>
                                <input type="date" class="form-control" name="due_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Heures estimées</label>
                                <input type="number" class="form-control" name="estimated_hours">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Ajouter ce script à la fin de project_detail.html, remplacer le script existant -->
<script>
const projectId = {{ project.id }};
let taskModal = null;
let currentTask = null;
let canManageProject = false;

document.addEventListener('DOMContentLoaded', function() {
    // Initialiser le modal Bootstrap
    const taskModalEl = document.getElementById('taskModal');
    if (taskModalEl) {
        taskModal = new bootstrap.Modal(taskModalEl);
    }
    
    // Charger les données du projet
    loadProjectData();
    
    // Charger la liste des utilisateurs pour l'assignation
    loadTeamMembers();
    
    // Écouter les changements d'onglet
    const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabButtons.forEach(button => {
        button.addEventListener('shown.bs.tab', function(e) {
            const targetId = e.target.getAttribute('href').substring(1);
            if (targetId === 'tasks') {
                loadProjectData();
            }
        });
    });
});

async function loadProjectData() {
    try {
        const response = await fetch(`/projects/api/${projectId}`);
        const data = await response.json();
        
        if (data.success) {
            console.log('Données du projet:', data.project);
            canManageProject = data.project.can_manage;
            updateStats(data.project);
            loadTasks(data.project.tasks || []);
            loadTeam(data.project.members || []);
            loadMilestones(data.project.milestones || []);
            loadUpcomingTasks(data.project.tasks || []);
        } else {
            console.error('Erreur:', data.error);
            showAlert('error', 'Impossible de charger les données du projet');
        }
    } catch (error) {
        console.error('Erreur de chargement:', error);
        showAlert('error', 'Erreur de connexion au serveur');
    }
}

function updateStats(project) {
    const taskCount = document.getElementById('taskCount');
    const memberCount = document.getElementById('memberCount');
    
    if (taskCount) taskCount.textContent = project.task_count || 0;
    if (memberCount) memberCount.textContent = project.member_count || 0;
    
    const completedTasks = project.tasks ? 
        project.tasks.filter(t => t.status === 'completed').length : 0;
    const completedTasksEl = document.getElementById('completedTasks');
    if (completedTasksEl) {
        completedTasksEl.textContent = `${completedTasks} tâches terminées`;
    }
}

function loadTasks(tasks) {
    const container = document.getElementById('tasksContainer');
    
    if (!container) {
        console.error('Container tasksContainer non trouvé');
        return;
    }
    
    if (!tasks || tasks.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-tasks fa-3x mb-3"></i>
                <p>Aucune tâche créée pour ce projet</p>
                <button class="btn btn-primary mt-3" onclick="openTaskModal()">
                    <i class="fas fa-plus"></i> Créer la première tâche
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = tasks.map(task => `
        <div class="task-item">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <h6 class="mb-0">${escapeHtml(task.title)}</h6>
                        <span class="badge status-${task.status}">
                            ${getStatusLabel(task.status)}
                        </span>
                        <span class="badge priority-${task.priority.toLowerCase()}">
                            ${task.priority}
                        </span>
                    </div>
                    
                    ${task.description ? `<p class="text-muted mb-2">${escapeHtml(task.description)}</p>` : ''}
                    
                    <div class="d-flex gap-3 align-items-center flex-wrap">
                        ${task.assigned_to ? `
                            <span class="text-muted">
                                <i class="fas fa-user"></i> ${escapeHtml(task.assigned_to.name)}
                            </span>
                        ` : '<span class="text-muted"><i class="fas fa-user-slash"></i> Non assigné</span>'}
                        
                        ${task.due_date ? `
                            <span class="text-muted">
                                <i class="fas fa-calendar"></i> 
                                ${new Date(task.due_date).toLocaleDateString('fr-FR')}
                            </span>
                        ` : ''}
                        
                        ${task.estimated_hours ? `
                            <span class="text-muted">
                                <i class="fas fa-clock"></i> ${task.estimated_hours}h
                            </span>
                        ` : ''}
                    </div>
                </div>
                
                <div style="min-width: 180px;" class="ms-3">
                    <div class="progress-bar-custom mb-2">
                        <div class="progress-fill" style="width: ${task.progress_percentage || 0}%"></div>
                    </div>
                    <small class="text-muted">${task.progress_percentage || 0}% complété</small>
                    
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editTask(${task.id})" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${task.status !== 'completed' ? `
                            <button class="btn btn-sm btn-outline-success me-1" onclick="markTaskCompleted(${task.id})" title="Marquer comme terminée">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        ${canManageProject ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

async function loadTeamMembers() {
    try {
        const response = await fetch('/users/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.querySelector('#taskForm [name="assigned_to_id"]');
            if (select) {
                select.innerHTML = '<option value="">Non assigné</option>';
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.full_name || user.username;
                    select.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Erreur chargement utilisateurs:', error);
    }
}

function openTaskModal(taskId = null) {
    const form = document.getElementById('taskForm');
    const modalTitle = document.querySelector('#taskModal .modal-title');
    
    if (taskId) {
        // Mode édition
        currentTask = taskId;
        modalTitle.textContent = 'Modifier la Tâche';
        loadTaskForEdit(taskId);
    } else {
        // Mode création
        currentTask = null;
        modalTitle.textContent = 'Nouvelle Tâche';
        if (form) {
            form.reset();
        }
    }
    
    if (taskModal) {
        taskModal.show();
    }
}

async function loadTaskForEdit(taskId) {
    try {
        const response = await fetch(`/projects/api/tasks/${taskId}`);
        const data = await response.json();
        
        if (data.success) {
            const task = data.task;
            const form = document.getElementById('taskForm');
            
            form.querySelector('[name="title"]').value = task.title;
            form.querySelector('[name="description"]').value = task.description || '';
            form.querySelector('[name="assigned_to_id"]').value = task.assigned_to?.id || '';
            form.querySelector('[name="priority"]').value = task.priority;
            form.querySelector('[name="due_date"]').value = task.due_date ? task.due_date.split('T')[0] : '';
            form.querySelector('[name="estimated_hours"]').value = task.estimated_hours || '';
        }
    } catch (error) {
        console.error('Erreur:', error);
        showAlert('error', 'Impossible de charger la tâche');
    }
}

async function editTask(taskId) {
    openTaskModal(taskId);
}

async function saveTask() {
    const form = document.getElementById('taskForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    if (!data.title || data.title.trim() === '') {
        showAlert('warning', 'Le titre est requis');
        return;
    }
    
    // Convertir les champs vides en null
    Object.keys(data).forEach(key => {
        if (data[key] === '') {
            data[key] = null;
        }
    });
    
    try {
        let url, method;
        
        if (currentTask) {
            // Mode édition
            url = `/projects/api/tasks/${currentTask}`;
            method = 'PUT';
        } else {
            // Mode création
            url = `/projects/api/${projectId}/tasks`;
            method = 'POST';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: { 
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            taskModal.hide();
            showAlert('success', currentTask ? 'Tâche mise à jour avec succès' : 'Tâche créée avec succès');
            loadProjectData();
        } else {
            showAlert('error', result.error || 'Erreur lors de l\'enregistrement de la tâche');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showAlert('error', 'Erreur de connexion au serveur');
    }
}

async function markTaskCompleted(taskId) {
    if (!confirm('Marquer cette tâche comme terminée ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/projects/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: 'completed',
                progress_percentage: 100
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Tâche marquée comme terminée');
            loadProjectData();
        } else {
            showAlert('error', result.error || 'Erreur lors de la mise à jour');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showAlert('error', 'Erreur de connexion au serveur');
    }
}

async function deleteTask(taskId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/projects/api/tasks/${taskId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Tâche supprimée avec succès');
            loadProjectData();
        } else {
            showAlert('error', result.error || 'Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showAlert('error', 'Erreur de connexion au serveur');
    }
}

function loadTeam(members) {
    const container = document.getElementById('teamMembers');
    
    if (!container) return;
    
    if (!members || members.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5 text-muted">
                <i class="fas fa-users fa-3x mb-3"></i>
                <p>Aucun membre dans l'équipe</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = members.map(member => `
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="member-avatar mx-auto mb-3">
                        ${getInitials(member.name)}
                    </div>
                    <h6>${escapeHtml(member.name)}</h6>
                    <p class="text-muted mb-1">${member.role || 'Membre'}</p>
                    <small class="text-muted">${member.allocation}% allocation</small>
                </div>
            </div>
        </div>
    `).join('');
}

function loadMilestones(milestones) {
    const container = document.getElementById('milestonesContainer');
    
    if (!container) return;
    
    if (!milestones || milestones.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-flag fa-3x mb-3"></i>
                <p>Aucun jalon défini</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = milestones.map(milestone => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${escapeHtml(milestone.name)}</h6>
                        <p class="text-muted mb-0">
                            <i class="fas fa-calendar"></i> 
                            ${new Date(milestone.target_date).toLocaleDateString('fr-FR')}
                        </p>
                    </div>
                    <span class="badge status-${milestone.status}">
                        ${getMilestoneStatusLabel(milestone.status)}
                    </span>
                </div>
            </div>
        </div>
    `).join('');
}

function loadUpcomingTasks(tasks) {
    const container = document.getElementById('upcomingTasks');
    if (!container) return;
    
    const upcoming = tasks.filter(t => {
        if (!t.due_date || t.status === 'completed') return false;
        const dueDate = new Date(t.due_date);
        const now = new Date();
        const diff = (dueDate - now) / (1000 * 60 * 60 * 24);
        return diff >= 0 && diff <= 7;
    }).sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
    
    if (upcoming.length === 0) {
        container.innerHTML = '<p class="text-muted">Aucune échéance dans les 7 prochains jours</p>';
        return;
    }
    
    container.innerHTML = upcoming.map(task => `
        <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
            <div>
                <strong>${escapeHtml(task.title)}</strong>
                <br>
                <small class="text-muted">
                    ${new Date(task.due_date).toLocaleDateString('fr-FR')}
                </small>
            </div>
            <span class="badge priority-${task.priority.toLowerCase()}">${task.priority}</span>
        </div>
    `).join('');
}

// Fonctions utilitaires
function getStatusLabel(status) {
    const labels = {
        'todo': 'À faire',
        'in_progress': 'En cours',
        'in_review': 'En revue',
        'completed': 'Terminé',
        'blocked': 'Bloqué'
    };
    return labels[status] || status;
}

function getMilestoneStatusLabel(status) {
    const labels = {
        'pending': 'En attente',
        'reached': 'Atteint',
        'missed': 'Manqué'
    };
    return labels[status] || status;
}

function getInitials(name) {
    if (!name) return '?';
    return name.split(' ')
        .map(n => n[0])
        .join('')
        .toUpperCase()
        .substring(0, 2);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}